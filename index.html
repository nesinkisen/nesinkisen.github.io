<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE-Edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>stock</title>

        <style>
            .bs-example{
                margin: 20px;
            }
            .close {display: none;}

            body {font-family: Arial;}

/* Style the tab */
.tab {
  overflow: hidden;
  border: 1px solid #ccc;
  background-color: #f1f1f1;
}

/* Style the buttons inside the tab */
.tab button {
  background-color: inherit;
  float: left;
  border: none;
  outline: none;
  cursor: pointer;
  padding: 14px 16px;
  transition: 0.3s;
  font-size: 17px;
}

/* Change background color of buttons on hover */
.tab button:hover {
  background-color: #ddd;
}

/* Create an active/current tablink class */
.tab button.active {
  background-color: #ccc;
}

/* Style the tab content */
.tabcontent {
  display: none;
  padding: 6px 12px;
  border: 1px solid #ccc;
  border-top: none;
}          

.btnIcon {
  background-color: DodgerBlue;
  border: none;
  color: white;
  padding: 12px 16px;
  font-size: 16px;
  cursor: pointer;
}

/* Darker background on mouse-over */
.btnIcon:hover {
  background-color: RoyalBlue;
}
        </style>        
    </head>
    <body>
        <img src="Sunrise_Image.jpg" height="60" width="300">
        <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>-->
        <script src="//sdk-cdn.mypurecloud.com/client-apps/1.3.0/purecloud-client-app-sdk.js"></script>
        <script src="https://sdk-cdn.mypurecloud.com/javascript/latest/purecloud-platform-client-v2.min.js"></script>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>   
        <link href='https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/ui-lightness/jquery-ui.css'rel='stylesheet'>
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" ></script>

        <link rel="stylesheet" href="./styles/style.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/js/bootstrap-datetimepicker.min.js"></script>        
        <script src="https://www.gstatic.com/firebasejs/5.0.4/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/5.0.4/firebase-firestore.js"></script>

        <!--<script src="https://apps.mypurecloud.ie"></script>-->
        <script src="app.js"></script>
        <script src="dialer.js"></script>
        <script type="module">
            // Import the functions you need from the SDKs you need
            // TODO: Add SDKs for Firebase products that you want to use
            // https://firebase.google.com/docs/web/setup#available-libraries
          
            // Your web app's Firebase configuration
            const firebaseConfig = {
              apiKey: "AIzaSyBOG7xTyTBoTSt-R8XJAWY2mHG1jEgNyjk",
              authDomain: "blazorweb-e36f2.firebaseapp.com",
              databaseURL: "https://blazorweb-e36f2-default-rtdb.firebaseio.com",
              projectId: "blazorweb-e36f2",
              storageBucket: "blazorweb-e36f2.appspot.com",
              messagingSenderId: "831465406902",
              appId: "1:831465406902:web:c3b00d757a11db51510117"
            };
          
            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            db.settings({timestampsInSnapshots:true});

            import {getDatabase, ref, get, set, child, update, remove}
            from "https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js"

            var btnSave = document.getElementById("btnSave");

            function saveCallback()
            {
                db.collection("callbacks").doc($('#customerIdModal').val()).set({
                    customerId: $('#customerIdModal').val(),
                    phone: $('#phoneNumberModal').val(),
                    scheduled_time: $("#datetimepicker1").find("input").val(),
                    agent: agentNameKeepFor,
                    status: 'Open',
                    notes: $('#notesModal').val()
                })
            }      

            var tbody = document.getElementById('tbody1');
            function AddItemToTable(customerId, phone, scheduled_time, agent, dueIn, notes, backgroundColor)
            {
                let trow = document.createElement("tr");

                let dynamicImage = document.createElement('img');
                dynamicImage.src = "perform_image.png";
                dynamicImage.style.width = "35px";
                dynamicImage.style.height = "35px";
                dynamicImage.setAttribute("id", customerId);
                dynamicImage.style.cursor = "pointer";
                dynamicImage.onclick= function () 
                {
                    updateCallbackById(dynamicImage.getAttribute("id"));
                };

                let td1 = document.createElement("td");
                let td2 = document.createElement("td");
                let td3 = document.createElement("td");
                let td4 = document.createElement("td");
                let td5 = document.createElement("td");
                let td6 = document.createElement("td");

                td5.style.backgroundColor = backgroundColor;
                td5.style.color = "white";

                td1.innerHTML = customerId;
                td2.innerHTML = phone;
                td3.innerHTML = scheduled_time;
                td4.innerHTML = agent;
                td5.innerHTML = dueIn;
                td6.innerHTML = notes;

                trow.appendChild(dynamicImage);
                trow.appendChild(td1);
                trow.appendChild(td2);
                trow.appendChild(td3);
                trow.appendChild(td4);
                trow.appendChild(td5);
                trow.appendChild(td6);

                tbody.appendChild(trow);
            }

            function AddAllItemsToTable(TheCallback)
            {
                tbody.innerHTML="";
                TheCallback.forEach(element =>
                {
                    AddItemToTable(element.customerId, element.phone, element.scheduled_time, element.agent, element.dueIn, element.notes, element.backgroundColor);
                })
            }

            function GetCallbacks()
            {
                var indexCount = 0; //fix it               

                db.collection('callbacks').get()
                .then((snapshot)=>
                {
                    var callbacks = [];                  
                    
                    snapshot.docs.forEach(childSnapShot => 
                    {
                        if(childSnapShot.data().status == "Open" && childSnapShot.data().agent == me.name)
                        {
                            callbacks.push(childSnapShot.data());
                            
                            var scheduledDateTime = new Date(childSnapShot.data().scheduled_time.replace(" ", "T"));

                            const dateNow = new Date();

                            var timeDiff = scheduledDateTime.getTime() - dateNow.getTime();
                            timeDiff = Math.floor(timeDiff / 1000 / 60) + 1;

                            var dueIn;
                            var colorDesc;
                            dueIn = dueInCalculation(timeDiff);
                            colorDesc = colorCalculation(timeDiff);
                            Object.assign(callbacks[indexCount], {"dueIn": dueIn});
                            Object.assign(callbacks[indexCount], {"backgroundColor": colorDesc});

                            if(timeDiff <= 2)
                            {
                                $('#popUpModal').modal(
                                {
                                    backdrop: 'static'
                                });

                                $('#lblCustomerIdPopUp').text(childSnapShot.data().customerId);
                                $('#lblPhoneNumberPopUp').text(childSnapShot.data().phone);
                                $('#lblScheduledTimePopUp').text(childSnapShot.data().scheduled_time);
                                $('#lblAgentNamePopUp').text(childSnapShot.data().agent);
                                $('#lblAgentNamePopUp').text(childSnapShot.data().agent);
                                $('#lblNotesPopUp').text(childSnapShot.data().notes);
                                $('#tdSubjectPopUp').text("Site id: " + childSnapShot.data().customerId);
                                $('#tdDueInPopUp').text(dueIn);

                            }
                            indexCount++;
                        }
                    });
                    AddAllItemsToTable(callbacks);
                })
            }

            function colorCalculation(diffMinutes)
            {
                if(diffMinutes >= 60)
                    return "#A3D300";
                else if (diffMinutes >= 30 && diffMinutes < 60)
                    return "#B6CF04";
                else if (diffMinutes >= 10 && diffMinutes < 30)
                    return "limegreen";
                else if (diffMinutes >= 0 && diffMinutes < 10)
                    return "#ED8500";                    
                else if (diffMinutes < 0)
                    return "#B01500";                                        
            }

            function updateCallback()
            {
                db.collection("callbacks").doc($('#lblCustomerIdPopUp').text()).update({
                    status: 'Closed'
                })                
            }     
            
            function updateCallbackById(customerId)
            {
                const date = new Date();
                date.setMinutes(date.getMinutes() + 2);

                db.collection("callbacks").doc(customerId).update(
                {
                    scheduled_time: dateFormat(date)
                })    
                .then(()=>
                {
                    GetCallbacks();
                });                             
            }              
            
            btnSaveScheduleCallback.addEventListener('click', saveCallback);
            btnGet.addEventListener('click', GetCallbacks);
            btnDialNow.addEventListener('click', updateCallback);
        </script>        

        <script type="text/javascript">
            // Obtain a reference to the platformClient object
            const platformClient = require('platformClient');
        </script>

        <script>
            var lifecycleStatusMessageTitle = 'Lifecycle Demo App';
            var lifecycleStatusMessageId = 'lifecycleDemo-statusMsg';
            var blurCount = 0;
            var userApiInstance;
            var presenceApiInstance;
            var conversationsApi;
            var analyticsApi;
            var routingApi;
            var notificationsApi;
            var outboundApi;
            var userId;
            // Local vars
            var presences = {};
            var userPresenceTopic = '';
            var userPresenceTopicArr = [];
            var webSocket = null;
            var me, notificationChannel, conversationsTopic;
            var CONVERSATION_LIST_TEMPLATE = null;
            var conversationList = {};     
            var customerIdKeepFor;
            var phoneNumberKeepFor;
            var scheduledTimeKeepFor;
            var agentNameKeepFor;
            var callbackOrNot = false;
            //npm install -g local-ssl-proxy
            // local-ssl-proxy --source 6500 --target 5500
            //const REDIRECT_URI = "https://nesinkisen.github.io";
            const REDIRECT_URI = "http://localhost:5500";  

            $( document ).ready(function() 
            {
                const client = platformClient.ApiClient.instance;
                
                //client.setEnvironment(platformClient.PureCloudRegionHosts.us_east_1); // Genesys Cloud region
                client.setEnvironment(platformClient.PureCloudRegionHosts.eu_west_1);

                // Create API instance
                //const usersApi = new platformClient.UsersApi();
                userId = "d2dab52a-8588-4942-8d44-fd8a2aa5d4a2"; // String | user Id    
                
                userApiInstance = new platformClient.UsersApi();
                presenceApiInstance = new platformClient.PresenceApi();
                conversationsApi = new platformClient.ConversationsApi();
                analyticsApi = new platformClient.AnalyticsApi(); 
		        routingApi = new platformClient.RoutingApi();       
                notificationsApi = new platformClient.NotificationsApi();
                outboundApi = new platformClient.OutboundApi();  

                // Authenticate
                client.loginImplicitGrant("4661d5c1-d791-478f-b440-3cc36f9cb882", REDIRECT_URI)
                .then(() => {
                    // Make request to GET /api/v2/users/me?expand=presence
                    return userApiInstance.getUsersMe({ 'expand': ["presence"] });
                })
                .then((userMe) => {
                    // Handle successful result
                    console.warn(`Hello, ${userMe.name}!`);
                })
/////////////////////////////////////////////////////////
				.then(() => {
					console.log('Logged in');

					// Get presences
					return presenceApiInstance.getPresencedefinitions({ pageSize: 100 });
				})
				.then((presenceListing) => {
					console.log(`Found ${presenceListing.entities.length} presences`);

					// Create button for each presence
					presenceListing.entities.forEach((presence) => {
						presences[presence.id] = presence;
						$('div#presenceButtons').append($('<button>')
							.addClass('btn btn-primary')
							.click(() => setPresence(presence.id))
							.text(presence.languageLabels.en_US)
						);
					});

					// Get authenticated user's data, including current presence
					return userApiInstance.getUsersMe({ expand: ['presence'] });
				})
				.then(async (userMe) => {
					me = userMe;

					
					// Set current presence text in UI
					$('#currentPresence').text(presences[me.presence.presenceDefinition.id].languageLabels.en_US);

					// Create notification channel
                    
					const channel = await notificationsApi.postNotificationsChannels();
                    console.log("channel: ", channel);
                    

                    return channel;
				})
				/*.then(async (channel) => {
					console.log('channelStatus: ', channel);
					notificationChannel = channel;

					// Set up web socket
					webSocket = new WebSocket(notificationChannel.connectUri);
					webSocket.onmessage = handleNotification;

					// Subscribe to authenticated user's presence
					userPresenceTopic = `v2.users.${me.id}.presence`;
                    userPresenceTopicArr = ["v2.users.${me.id}.presence", "v2.users.30a95f8c-d73e-463f-a72c-bff2c10925bc.presence"];
                    //userPresenceTopic = `v2.users.30a95f8c-d73e-463f-a72c-bff2c10925bc.presence`;
                    //userPresenceTopic = `v2.analytics.conversation.${me.id}.metrics`;
					const body = [ { id: userPresenceTopic } ];
					
                    const putChannel = await notificationsApi.putNotificationsChannelSubscriptions(notificationChannel.id, body);
                    console.log("putChannel", putChannel);

                    return putChannel;
				})*/
                .then((channelCall) => {
                    console.log('channelCall: ', channelCall);
                    notificationChannel = channelCall;

                    // Set up web socket
                    webSocket = new WebSocket(notificationChannel.connectUri);
                    webSocket.onmessage = handleNotification;

                    // Subscribe to authenticated user's conversations
                    conversationsTopic = 'v2.users.' + me.id + '.conversations';
                    const body = [ { id: conversationsTopic } ];
                    return notificationsApi.putNotificationsChannelSubscriptions(notificationChannel.id, body);
                })     
                /*.then((topicSubscriptions) => {
                    console.log('topicSubscriptions: ', topicSubscriptions);

                    CONVERSATION_LIST_TEMPLATE = Handlebars.compile($('#entry-template').html());

                    // Handle dial button click
                    $('button#dial').click(() => {
                        // Create request body
                        let body = {
                            'phoneNumber':$('input#dialstring').val()
                        };

                        // Invoke API
                        conversationsApi.postConversationsCalls(body).then(() => {
                            // Clear dialstring from text box
                            $('input#dialstring').val('');
                        }).catch((err) => console.error(err));
                    });
                })*/
				/*.then(() => {
					console.log('Logged in');

					// Get a list of contact lists
					return outboundApi.getOutboundContactlists({ pageSize: 100 });
                    //var aaaa = outboundApi.getOutboundContactlists({ pageSize: 100 });
				})
				.then((contactLists) => {
					// Add contact lists to the UI
					contactLists.entities.forEach((contactList) => 
                    {
                        console.warn(contactList.id + " --- " + contactList.name);
						//$('#contactLists').append($('<option></option>')
						//	.attr('value', contactList.id)
						//	.text(contactList.name));
					});
				})*/                
                                                     
/////////////////////////////////////////////////////////
                .catch((err) => {
                    // Handle failure response
                    console.log(err);
                });

                // userApiInstance.getUserRoles("d2dab52a-8588-4942-8d44-fd8a2aa5d4a2")
                // .then((data) => {
                //     console.log(`getUserRoles success! data: ${JSON.stringify(data, null, 2)}`);
                // })
                // .catch((err) => {
                //     console.log("There was a failure calling getUserRoles");
                //     console.error(err);
                // });

                // var subjectId2 = "d2dab52a-8588-4942-8d44-fd8a2aa5d4a2"; // String | User ID
                // var body2 = ["c5e7d1bc-bb87-4f97-9b57-6029a8836382", 'bb17694e-d819-44e8-9fda-8248a75977e6',
                // '42eb2428-7a90-4ceb-b4a1-5a736f2dec1a', 'b71f19e4-e02a-4ed5-b23b-61c85bf35e82', '530588e7-94e0-4972-941c-cc820be4cb8f',
                // '5385a7ac-b44d-4828-96ad-dbbc11642a89', '297fb221-2ef1-4ba8-a5eb-041c4174b35d', 'e386b333-9083-4528-a474-1a6d4ad8e5f1',
                // '2cce73fd-a3fe-4560-a0f2-506105c4ba9c', '0db53709-d760-476e-84fe-af1b428e97e4', '2dcb7985-b5fc-46c2-90dd-f9d7841c083e'];

                // // Sets the user's roles
                // userApiInstance.putUserRoles(subjectId2, body2)
                // .then((data) => {
                //     console.log(`putUserRoles success! data: ${JSON.stringify(data, null, 2)}`);
                // })
                // .catch((err) => {
                //     console.log("There was a failure calling putUserRoles");
                //     console.error(err);
                // });      
                
                /*
                let body = {
                "order": "desc",
                "orderBy": "conversationStart",
                "interval": "2022-09-19T00:00:00.000Z/2022-09-21T00:00:00.000Z",
                "paging": {
                    "pageSize": 100,
                    "pageNumber": 1
                },
                "segmentFilters": [
                    {
                    "type": "and",
                    "predicates": [
                        {
                        "dimension": "direction",
                        "value": "inbound"
                        },
                        {
                        "dimension": "mediaType",
                        "value": "message"
                        },
                        {
                        "dimension": "messageType",
                        "value": "webmessaging"
                        }
                    ]
                    }
                ]
                }; // Object | query

                // Query for conversation details
                conversationsApi.postAnalyticsConversationsDetailsQuery(body)
                .then((data) => {
                    console.log(`postAnalyticsConversationsDetailsQuery success! data: ${JSON.stringify(data, null, 2)}`);
                })
                .catch((err) => {
                    console.log("There was a failure calling postAnalyticsConversationsDetailsQuery");
                    console.error(err);
                }); 
                */              

                let opts = { 
                "expand": ["expand_example"], // [String] | Which fields, if any, to expand.
                "integrationPresenceSource": "integrationPresenceSource_example" // String | Get your presence for a given integration. This parameter will only be used when presence is provided as an expand.
                };

                $('#btnScheduleCallback').click(function(){
                    $('#scheduleCallbackModal').modal(
                    {
                        backdrop: 'static'
                    });
                    $("#phoneNumberModal").val(phoneNumberKeepFor);
                });

                $('#btnSaveScheduleCallback').click(function() 
                {
                    $('#scheduleCallbackModal').modal('hide');
                    $("#ParisTab").css("display", "none");
                    $("#Paris").css("display", "none");
                    document.getElementById("LondonTab").click();
                    document.getElementById("btnGet").click();
                });
                
                $('#btnCloseScheduleCallback').click(function() 
                {
                    $('#scheduleCallbackModal').modal('hide');
                });

                $('#btnDialNow').click(function() 
                {
                    callbackOrNot = true;
                    MakeCall($("#lblPhoneNumberPopUp").text());
                    $('#popUpModal').modal('hide');
                });    

                $('#btnCloseCloseTab').click(function() 
                {
                    $("#CloseCallbackTab").css("display", "none");
                    $("#CloseCallback").css("display", "none");
                    document.getElementById("LondonTab").click();
                    document.getElementById("btnGet").click();
                });                
                       
                var frameWindow = document.getElementById(REDIRECT_URI).contentWindow;

                frameWindow.addEventListener("load"), function(){
                    var doc = iframe.contentDocument || iframe.contentWindow.document;
                    var target = doc.getElementById("https://apps.mypurecloud.ie");

                    target.innerHTML = "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa";
                    console.warn(target.innerHTML);
                }
                
            });
////////////////////////////////////////////////////////////////////////////
        function setPresence(presenceId) {
			console.log(`Setting presence to ${presences[presenceId].languageLabels.en_US} (${presenceId})`);

			// Set presence
			presenceApiInstance.patchUserPresence(me.id, 'PURECLOUD', { presenceDefinition:{ id: presenceId } })
				.then(() => {
					console.log('Presence set successfully');
				})
				.catch((err) => console.error(err));
		}


        /*
		// Handle incoming Genesys Cloud notification from WebSocket
		function handleNotification(message) {
			// Parse notification string to a JSON object
                    const notification = JSON.parse(message.data);

                    // Discard unwanted notifications
                    if (notification.topicName.toLowerCase() === 'channel.metadata') {
                        // Heartbeat
                        console.info('Ignoring metadata: ', notification);
                        return;
                    } else if (notification.topicName.toLowerCase() !== userPresenceTopic.toLowerCase()) {
                        // Unexpected topic
                        console.warn('Unknown notification: ', notification);
                        return;
                    } else {
                        console.debug('Presence notification: ', notification);
                    }

                    // Set current presence text in UI
                    $('#currentPresence').text(presences[notification.eventBody.presenceDefinition.id].languageLabels.en_US);

                    // Log messages
                    $('div#messages').append($('<pre>').text(`${new Date().toLocaleTimeString()} - ${JSON.stringify(notification,null,2)}`));
                }
            
            */
            function handleNotification(message) 
            {
            // Parse notification string to a JSON object
            const notification = JSON.parse(message.data);

            // Discard unwanted notifications
            if (notification.topicName.toLowerCase() === 'channel.metadata') {
                // Heartbeat
                console.info('Ignoring metadata: ', notification);
                return;
            } else if (notification.topicName.toLowerCase() !== conversationsTopic.toLowerCase()) {
                // Unexpected topic
                console.warn('Unknown notification: ', notification);
                return;
            } else 
            {
                console.debug('Conversation notification: ', notification);
                if(typeof notification.eventBody.participants[1].calls[0].state !== "undefined")
                {
                    if(notification.eventBody.participants[1].calls[0].state == "connected")
                    {
                        if(!callbackOrNot)
                        {
                            console.warn("evreka connected");
                            document.getElementById("ParisTab").style.display = "inline";
                            $("#ParisTab").css("background-color","gold");
                            openCity(event, 'Paris');

                            phoneNumberKeepFor = notification.eventBody.participants[1].address.substr(notification.eventBody.participants[1].address.indexOf(":") + 1)
                            document.getElementById('lblPhoneNumberTab').innerHTML = phoneNumberKeepFor;
                            agentNameKeepFor = notification.eventBody.participants[1].calls[0].other.name;
                            document.getElementById('lblInteractionIdTab').innerHTML = notification.eventBody.participants[1].calls[0].id;
                        }
                    }
                    else if (notification.eventBody.participants[1].calls[0].state =="disconnected")
                    {
                        if(callbackOrNot)
                        {
                            console.warn("evreka disconnected")
                            document.getElementById("CloseCallbackTab").style.display = "inline";
                            $("#CloseCallbackTab").css("background-color","gold");
                            openCity(event, 'CloseCallback');

                            $("#txtClosePhoneNumberTab").val($("#lblPhoneNumberPopUp").text());
                            $("#txtCloseCustomerIdTab").val($("#lblCustomerIdPopUp").text());

                            callbackOrNot = false;
                        }
                    }
                }
            }

            // See function description for explanation
            copyCallPropsToParticipant(notification.eventBody);

            // Update conversation in list or remove it if disconnected
            /*
            if (isConversationDisconnected(notification.eventBody))
                delete conversationList[notification.eventBody.id];
            else
                conversationList[notification.eventBody.id] = notification.eventBody;
                */

            // Update UI
            ////$('#call-table').html(CONVERSATION_LIST_TEMPLATE(Object.values(conversationList)));
        }      
        function copyCallPropsToParticipant(conversation) 
        {
            console.warn("conversationLog: " + conversation);

            conversation.participants.forEach((participant) => {
                if (!participant.calls || participant.calls.length === 0) return;

                participant.ani = participant.calls[0].self.addressNormalized;
                participant.attributes = participant.additionalProperties;
                participant.confined = participant.calls[0].confined;
                participant.direction = participant.calls[0].direction;
                participant.dnis = participant.calls[0].other.addressNormalized;
                participant.held = participant.calls[0].held;
                participant.muted = participant.calls[0].muted;
                participant.provider = participant.calls[0].provider;
                participant.recording = participant.calls[0].recording;
                participant.recordingState = participant.calls[0].recordingState;
                participant.state = participant.calls[0].state;
                if (participant.userId)
                    participant.user = { id: participant.userId, selfUri: `/api/v2/users/${participant.userId}` };
                if (participant.calls[0].peerId)
                    participant.peer = participant.calls[0].peerId;
            });
        }          
        
////////////////////////////////////////////////////////////////////////////////
                     

            function getIntervalString() 
            {
                let end = new Date();
                let start = new Date();
                start.setDate(end.getDate() - 7);

                return start.toISOString() + '/' + end.toISOString();
		    };

               
            
// Determines if a conversation is disconnected by checking to see if all participants are disconnected
function isConversationDisconnected(conversation) {
	let isConnected = false;
	conversation.participants.some((participant) => {
		if (participant.state !== 'disconnected') {
			isConnected = true;
			return true;
		}
	});

	return !isConnected;
}          
        
function openCity(evt, cityName) {
  var i, tabcontent, tablinks;
  tabcontent = document.getElementsByClassName("tabcontent");
  for (i = 0; i < tabcontent.length; i++) {
    tabcontent[i].style.display = "none";
  }
  tablinks = document.getElementsByClassName("tablinks");
  for (i = 0; i < tablinks.length; i++) {
    tablinks[i].className = tablinks[i].className.replace(" active", "");
  }
  document.getElementById(cityName).style.display = "block";
  evt.currentTarget.className += " active";
}        

        window.onload = (event) => 
        {
            document.getElementById("LondonTab").click();
            document.getElementById("btnGet").click();
        };      
        $(function() 
        {
            var dateNow = new Date();
            $('#datetimepicker1').datetimepicker({
                format : 'YYYY-MM-DD HH:mm',
                defaultDate: dateNow
            });
        });
        var intervalId = window.setInterval(function()
        {
            if($('#popUpModal').is(':visible'))
            {
                var scheduledDateTime = new Date($('#lblScheduledTimePopUp').text().replace(" ", "T"));
                const dateNow = new Date();

                var timeDiff = scheduledDateTime.getTime() - dateNow.getTime();
                timeDiff = Math.floor(timeDiff / 1000 / 60) + 1;

                if(timeDiff <= 0)
                {
                    $('#popUpModal').modal('hide');
                    document.getElementById("btnDialNow").click(); 
                }
                else
                    $('#tdDueInPopUp').text(dueInCalculation(timeDiff));
            }
            else
                document.getElementById("btnGet").click();
        }, 20000);

        </script>     
        
        <div class="bs-example">
            <!--<input type="button" class="btn btn-lg btn-primary launch-modal" value="Launch Demo Modal">
            <button type="button" onclick="btnAvailable()" class="btn btn-success">Available</button>
            <button type="button" onclick="btnBusy()" class="btn btn-danger">Busyy</button>
            <button type="button" onclick="btnPreparing()" class="btn btn-warning">Preparing</button>
            <button type="button" onclick="btnMakeCall()" class="btn btn-secondary">Make a Call</button>-->
            <!--<button type="button" onclick="btnDisableStatus()"class="btn btn-info">Disable Status</button>
            <button type="button" onclick="btnDisableAll()" class="btn btn-dark">Disable All</button>-->
            <!--<input type="file" class="fileToUpload form-control" ></input><br>
            <input type="text" placeholder="File name" id="filename" class="form-control"/><br>
            <button class="btn btn-success" onclick="uploadfile()">Upload 7</button>
            <input type="text" id="txtPhoneNumber" value="+90 543" />-->
            
            <!-- Modal HTML -->
            <div id="scheduleCallbackModal" class="modal fade">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title" style="font-weight: bolder;">Scheduled Callback</h3>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <table>
                                    <tr>
                                        <td>
                                            <label for="customerIdModal">Customer Id:</label><br><br>
                                        </td>
                                        <td>
                                            <input type="text" id="customerIdModal" name="customerIdModal"><br><br>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <label for="phoneNumberModal">Contact Number:</label><br><br>
                                        </td>
                                        <td>
                                            <input type="text" id="phoneNumberModal" name="phoneNumberModal"><br><br>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <label for="scheduleTimeModal">Schedule Time:</label><br>
                                        </td>     
                                        <td>
                                            <div class="form-group">
                                                <div class='input-group date' id='datetimepicker1'>
                                                    <input type='text' class="form-control" />
                                                    <span class="input-group-addon">
                                                            <span class="glyphicon glyphicon-calendar"></span>
                                                    </span>
                                                </div>
                                            </div>
                                        </td>                           
                                    </tr>     
                                    <tr>
                                        <td>
                                            <label for="notesModal">Notes:</label><br>
                                        </td>
                                        <td>
                                            <input type="text" id="notesModal" name="notesModal"><br><br>
                                        </td>
                                    </tr>  
                                </table>  
                            </div>                             
                            <!--<p class="text-danger"><small>16/09/2022 16:35</small></p>-->
                            <!--<p class="text-info"><small><strong>Note:</strong> All Screen Disabled With This Pop Up</small></p>-->
                        </div>
                        <div class="modal-footer">
                            <button type="button" id="btnCloseScheduleCallback" class="btn btn-danger btn-primary mr-auto">Cancel</button>
                            <button type="button" id="btnSaveScheduleCallback" class="btn btn-info btn-secondary">Schedule Callback</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="popUpModal" class="modal fade">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title" style="font-weight: bolder;">Callback Reminder</h3>
                        </div>
                        <div class="modal-body" style="padding:4px;">
                            <tr>Customer Id:</tr>
                            <label id="lblCustomerIdPopUp"></label>                       
                        </div>                        
                        <div class="modal-body" style="padding:4px;">
                            <tr>Contact Number:</tr>
                            <label id="lblPhoneNumberPopUp"></label>
                        </div>
                        <div class="modal-body" style="padding:4px;">
                            <tr>Scheduled Time:</tr>
                            <label id="lblScheduledTimePopUp"></label>
                        </div>     
                        <div class="modal-body" style="padding:4px;">
                            <tr>Agent:</tr>
                            <label id="lblAgentNamePopUp"></label>
                        </div>     
                        <div class="modal-body" style="padding:4px;">
                            <tr>Notes:</tr>
                            <label id="lblNotesPopUp"></label>
                        </div>   
                        </br>
                        <table class="table table-bordered">
                            <thead style="background-color: lemonchiffon;">
                                <th>Subject</th>
                                <th>Due in</th>
                            </thead>
                            <thead>
                                <td id="tdSubjectPopUp"></td>
                                <td id="tdDueInPopUp"></td>
                            </thead>                            
                        </table>                                                                                      
                        <div class="modal-footer">
                            <!-- <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button> -->
                            <button type="button" id="btnDialNow" class="btn btn-primary">Dial Now</button>
                        </div>
                    </div>
                </div>
            </div>            
        </div>    

        <div class="tab">
            <button id="LondonTab" class="tablinks" onclick="openCity(event, 'London')">Scheduled Callbacks</button>
            <button id="ParisTab" class="tablinks" onclick="openCity(event, 'Paris')" style="display: none; border-style: inset;">New Callback</button>
            <button id="CloseCallbackTab" class="tablinks" onclick="openCity(event, 'CloseCallback')" style="display: none; border-style: inset;">Close Callback</button>
          </div>

          <div id="London" class="tabcontent">
            <button id ="btnGet" class="btnIcon"><i class="fa fa-refresh"></i></button>
            <div style="border-style: ridge;">
                <table class="table table-fixed" style="background-color: bisque;">
                    <thead>
                        <th></th>
                        <th>Customer ID</th>
                        <th>Phone</th>
                        <th>Scheduled Time</th>
                        <th>Agent Name</th>
                        <th>Due in</th>
                        <th>Notes</th>
                    </thead>
                    <tbody id="tbody1" style="background-color: white;"></tbody>
                </table>
                <br>
            </div>
            <!--<button id ="btnUpdate" type="button" class="btn btn-primary">Update Callback</button>-->
          </div>
          
          <div id="Paris" class="tabcontent">
            <div class="form-group">
                <tr>Name:</tr>
                <label>Engels Michael</label>
            </div>               
            <div class="form-group">
                <tr>Contact Number:</tr>
                <label id="lblPhoneNumberTab" name="phoneNumberTab"></label>
            </div>
            <div class="form-group">
                <tr>Workgroup:</tr>
            </div>   
            <div class="form-group">
                <tr>Interaction Id:</tr>
                <label id="lblInteractionIdTab" name="interactionIdTab"></label>
            </div>                     
            <input type="button" id="btnScheduleCallback" class="btn btn-lg btn-primary launch-modal" value="Schedule Callback">
          </div>
          
          <div id="CloseCallback" class="tabcontent">
            <div class="form-group">
                <label>Site Id:</label>
                <input type="text" id="txtCloseCustomerIdTab"><br>               
                <label>Contact Number:</label>
                <input type="text" id="txtClosePhoneNumberTab"><br>
            </div>
            <div class="form-group">
                <input type="radio" name="colors" id="red">Request Solved<br>
                <input type="radio" name="colors" id="blue">Customer Not Reached
            </div>     
            <br>
            <button type="button" id="btnCloseCloseTab" class="btn btn-info btn-secondary">Save</button>
    </body>
    
</html> 